name: CD Frontend - Déploiement automatique

# Déclenchement uniquement sur push vers main
on:
  push:
    branches:
      - main
      - ops-cicd
    paths:
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/cd-frontend.yml'

jobs:
  # ========================================
  # Job : Déploiement sur le serveur
  # ========================================
  deploy:
    name: Deploy Frontend to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Préparer le dossier de déploiement
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Créer le dossier de déploiement s'il n'existe pas
            mkdir -p ~/ecoguard
            cd ~/ecoguard
            
            # Nettoyer les anciens fichiers frontend
            rm -rf frontend
      
      - name: Copier les fichiers sur le serveur
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "frontend/*,docker-compose.yml"
          target: "~/ecoguard"
          overwrite: true
      
      - name: Build et déployer sur le serveur
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ~/ecoguard
            
            # Créer le réseau Docker s'il n'existe pas
            sudo docker network create ecoguard-network || true
            
            # Arrêter et supprimer l'ancien conteneur
            sudo docker stop ecoguard-frontend 2>/dev/null || true
            sudo docker rm ecoguard-frontend 2>/dev/null || true
            
            # Builder la nouvelle image
            sudo docker build -t ecoguard-frontend:latest ./frontend
            
            # Démarrer le nouveau conteneur
            sudo docker run -d \
              --name ecoguard-frontend \
              --restart unless-stopped \
              -p 8082:8082 \
              --network ecoguard-network \
              ecoguard-frontend:latest
            
            # Nettoyer les images non utilisées
            sudo docker image prune -f
      
      - name: Vérifier le déploiement
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ~/ecoguard
            
            # Vérifier que le conteneur tourne
            sudo docker ps | grep ecoguard-frontend
            
            # Afficher les logs récents
            sudo docker logs --tail 20 ecoguard-frontend
      
      - name: Notification de succès
        if: success()
        run: echo "Déploiement du frontend réussi sur ${{ secrets.SSH_HOST }}"
      
      - name: Notification d'échec
        if: failure()
        run: echo "Échec du déploiement du frontend"