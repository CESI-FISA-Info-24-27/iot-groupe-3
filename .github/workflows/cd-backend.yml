name: CD Backend - Déploiement automatique

# Déclenchement uniquement après succès du CI
on:
  workflow_run:
    workflows: ["CI EcoGuard IoT"]
    types:
      - completed

jobs:
  # ========================================
  # Job : Vérification des fichiers changés
  # ========================================
  check-changes:
    name: Check Backend Changes
    runs-on: ubuntu-latest
    # TEMPORAIRE: Accepte main ET ops-backend pour les tests
    # TODO: Retirer ops-backend après validation
    if: ${{ github.event.workflow_run.conclusion == 'success' && (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'ops-backend') }}
    outputs:
      backend-changed: ${{ steps.filter.outputs.backend }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check path filter
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'docker-compose.yml'
              - '.github/workflows/cd-backend.yml'

  # ========================================
  # Job : Déploiement sur le serveur
  # ========================================
  deploy:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest
    needs: [check-changes]
    # Ne déployer que si le CI a réussi ET que des fichiers backend ont changé
    if: ${{ needs.check-changes.outputs.backend-changed == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Préparer le dossier de déploiement
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Créer le dossier de déploiement s'il n'existe pas
            mkdir -p ~/ecoguard
            cd ~/ecoguard
            
            # Créer le dossier pour la base de données SQLite (persistant)
            mkdir -p ~/ecoguard/data/backend
            
            # Nettoyer les anciens fichiers backend (sauf la BDD)
            rm -rf backend
      
      - name: Copier les fichiers sur le serveur
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "backend/*,docker-compose.yml"
          target: "~/ecoguard"
          overwrite: true
      
      - name: Créer le fichier .env pour le backend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ~/ecoguard/backend
            
            # Créer le fichier .env avec la configuration SQLite
            cat > .env << EOF
            DATABASE_URL=sqlite:////app/data/ecoguard.db
            EOF
            
            echo "Fichier .env créé avec DATABASE_URL configurée"
      
      - name: Build et déployer sur le serveur
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ~/ecoguard
            
            # Créer le réseau Docker s'il n'existe pas
            docker network create ecoguard-network || true
            
            # Arrêter et supprimer l'ancien conteneur
            docker stop ecoguard-backend 2>/dev/null || true
            docker rm ecoguard-backend 2>/dev/null || true
            
            # Builder la nouvelle image
            docker build -t ecoguard-backend:latest ./backend
            
            # Démarrer le nouveau conteneur avec volume pour SQLite
            docker run -d \
              --name ecoguard-backend \
              --restart unless-stopped \
              -p 8081:8000 \
              --network ecoguard-network \
              -v ~/ecoguard/data/backend:/app/data \
              --env-file ~/ecoguard/backend/.env \
              ecoguard-backend:latest
            
            # Nettoyer les images non utilisées
            docker image prune -f
      
      - name: Vérifier le déploiement
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ~/ecoguard
            
            # Vérifier que le conteneur tourne
            docker ps | grep ecoguard-backend
            
            # Attendre quelques secondes pour l'initialisation
            sleep 5
            
            # Afficher les logs récents
            docker logs --tail 30 ecoguard-backend
            
            # Test de santé sur l'endpoint root
            echo "Test de santé du backend..."
            curl -f http://localhost:8081/ || echo "⚠️ Health check failed - vérifier les logs"
            
            # Vérifier que la base de données a été créée
            if [ -f ~/ecoguard/data/backend/ecoguard.db ]; then
              echo "Base de données SQLite créée avec succès"
              ls -lh ~/ecoguard/data/backend/ecoguard.db
            else
              echo "Base de données SQLite non trouvée"
            fi
      
      - name: Notification de succès
        if: success()
        run: echo "Déploiement du backend réussi sur ${{ secrets.SSH_HOST }}"
      
      - name: Notification d'échec
        if: failure()
        run: |
          echo "Échec du déploiement du backend"
          exit 1
