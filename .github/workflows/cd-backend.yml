name: CD Backend - D√©ploiement automatique

# D√©clenchement uniquement apr√®s succ√®s du CI
on:
  workflow_run:
    workflows: ["CI EcoGuard IoT"]
    types:
      - completed

jobs:
  # ========================================
  # Job : V√©rification des fichiers chang√©s
  # ========================================
  check-changes:
    name: Check Backend Changes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    outputs:
      backend-changed: ${{ steps.filter.outputs.backend }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
      
      - name: Check path filter
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'docker-compose.yml'
              - '.github/workflows/cd-backend.yml'

  # ========================================
  # Job : D√©ploiement sur le serveur
  # ========================================
  deploy:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.backend-changed == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
      
      - name: Pr√©parer le dossier de d√©ploiement
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            
            # Cr√©er le dossier de d√©ploiement s'il n'existe pas
            mkdir -p $HOME/ecoguard
            cd $HOME/ecoguard
            
            # Cr√©er le dossier pour la base de donn√©es SQLite (partag√© avec sqlite-web)
            mkdir -p $HOME/data
            
            # Nettoyer les anciens fichiers backend (sauf la BDD)
            rm -rf backend
      
      - name: Copier les fichiers sur le serveur
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "backend/*,docker-compose.yml"
          target: "~/ecoguard"
          overwrite: true
      
      - name: Cr√©er le fichier .env pour le backend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd $HOME/ecoguard/backend
            
            # Cr√©er le fichier .env avec la configuration SQLite
            cat > .env << EOF
            DATABASE_URL=sqlite:////app/data/ecoguard.db
            EOF
            
            echo "Fichier .env cr√©√© avec DATABASE_URL configur√©e"
      
      - name: Build et d√©ployer sur le serveur
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            cd $HOME/ecoguard
            
            # Cr√©er le r√©seau Docker s'il n'existe pas
            docker network create ecoguard-network || true
            
            # Arr√™ter et supprimer l'ancien conteneur
            docker stop ecoguard-backend 2>/dev/null || true
            docker rm ecoguard-backend 2>/dev/null || true
            
            # Builder la nouvelle image avec timeout
            timeout 10m docker build -t ecoguard-backend:latest ./backend
            
            # D√©marrer le nouveau conteneur avec volume pour SQLite (partag√© avec sqlite-web)
            docker run -d \
              --name ecoguard-backend \
              --restart unless-stopped \
              --security-opt apparmor=unconfined \
              -p 8081:8000 \
              --network ecoguard-network \
              -v $HOME/data:/app/data \
              --env-file $HOME/ecoguard/backend/.env \
              ecoguard-backend:latest
            
            # Attendre que le conteneur d√©marre
            echo "‚è≥ Attente du d√©marrage du conteneur..."
            sleep 3
            
            # V√©rifier si le conteneur tourne
            if docker ps --filter name=ecoguard-backend --format "{{.Names}}" | grep -q ecoguard-backend; then
              echo "‚úÖ Conteneur d√©marr√© avec succ√®s"
            else
              echo "‚ùå Le conteneur n'a pas d√©marr√©, v√©rification des logs..."
              docker logs ecoguard-backend 2>&1 || echo "Pas de logs disponibles"
              exit 1
            fi
            
            # Nettoyer les images non utilis√©es
            docker image prune -f
      
      - name: V√©rifier le d√©ploiement
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            cd $HOME/ecoguard
            
            # V√©rifier que le conteneur tourne
            echo "üîç V√©rification du statut du conteneur..."
            docker ps --filter name=ecoguard-backend --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || exit 1
            
            # V√©rifier la politique de red√©marrage automatique
            echo "üîÑ V√©rification de la politique de red√©marrage..."
            RESTART_POLICY=$(docker inspect ecoguard-backend --format='{{.HostConfig.RestartPolicy.Name}}')
            if [ "$RESTART_POLICY" = "unless-stopped" ]; then
              echo "‚úÖ Politique de red√©marrage: $RESTART_POLICY (le conteneur red√©marrera automatiquement)"
            else
              echo "‚ö†Ô∏è Politique de red√©marrage: $RESTART_POLICY (devrait √™tre 'unless-stopped')"
            fi
            
            # Attendre l'initialisation compl√®te
            echo "‚è≥ Attente de l'initialisation (10s)..."
            sleep 10
            
            # Afficher les logs r√©cents
            echo "üìã Logs du conteneur:"
            docker logs --tail 50 ecoguard-backend
            
            # Test de sant√© sur l'endpoint root
            echo "üè• Test de sant√© du backend..."
            if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:8081/ | grep -q "200\|404"; then
              echo "‚úÖ API r√©pond correctement"
            else
              echo "‚ùå L'API ne r√©pond pas, v√©rification de l'√©tat du conteneur..."
              docker inspect ecoguard-backend --format='{{json .State}}' | jq .
              exit 1
            fi
            
            # V√©rifier que la base de donn√©es a √©t√© cr√©√©e
            echo "üíæ V√©rification de la base de donn√©es..."
            if [ -f $HOME/data/ecoguard.db ]; then
              echo "‚úÖ Base de donn√©es SQLite accessible"
              ls -lh $HOME/data/ecoguard.db
              echo "‚ÑπÔ∏è  BDD partag√©e avec sqlite-web sur port 8080"
            else
              echo "‚ÑπÔ∏è  Base de donn√©es pas encore cr√©√©e (normal si premi√®re initialisation)"
              ls -la $HOME/data/ || echo "Le dossier n'existe pas"
            fi
      
      - name: Notification de succ√®s
        if: success()
        run: echo "D√©ploiement du backend r√©ussi sur ${{ secrets.SSH_HOST }}"
      
      - name: Notification d'√©chec
        if: failure()
        run: |
          echo "√âchec du d√©ploiement du backend"
          exit 1
